<div class="modal-header">
  <div class="modal-header-content">
    <fa-icon [icon]="faShieldAlt" class="modal-icon"></fa-icon>
    <h4 class="modal-title">Cambiar Contraseña</h4>
  </div>
  <button
    type="button"
    class="btn-close"
    (click)="close()"
    [disabled]="loading"
    aria-label="Cerrar"
  >
    <fa-icon [icon]="faTimes"></fa-icon>
  </button>
</div>

<div class="modal-body">
  <div class="alert-info">
    <fa-icon [icon]="faLock" class="alert-icon"></fa-icon>
    <p>
      Por seguridad, debe ingresar su contraseña actual. La nueva contraseña debe tener al menos 8
      caracteres e incluir mayúsculas, minúsculas, números y caracteres especiales.
    </p>
  </div>

  <form [formGroup]="changePasswordForm" (ngSubmit)="onSubmit()" class="change-password-form">
    <!-- Contraseña Actual -->
    <div class="form-group">
      <label for="currentPassword" class="form-label">
        <fa-icon [icon]="faLock" class="label-icon"></fa-icon>
        Contraseña Actual
      </label>
      <div class="input-wrapper">
        <input
          [type]="showCurrentPassword ? 'text' : 'password'"
          id="currentPassword"
          class="form-control"
          [class.is-invalid]="hasError('currentPassword')"
          formControlName="currentPassword"
          placeholder="Ingrese su contraseña actual"
          autocomplete="current-password"
          [disabled]="loading"
        />
        <button
          type="button"
          class="password-toggle"
          (click)="togglePasswordVisibility('current')"
          [attr.aria-label]="showCurrentPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
        >
          <fa-icon [icon]="showCurrentPassword ? faEyeSlash : faEye"></fa-icon>
        </button>
      </div>
      <div class="error-message" *ngIf="hasError('currentPassword')">
        {{ getErrorMessage('currentPassword') }}
      </div>
    </div>

    <!-- Nueva Contraseña -->
    <div class="form-group">
      <label for="newPassword" class="form-label">
        <fa-icon [icon]="faLock" class="label-icon"></fa-icon>
        Nueva Contraseña
      </label>
      <div class="input-wrapper">
        <input
          [type]="showNewPassword ? 'text' : 'password'"
          id="newPassword"
          class="form-control"
          [class.is-invalid]="hasError('newPassword')"
          formControlName="newPassword"
          placeholder="Ingrese su nueva contraseña"
          autocomplete="new-password"
          [disabled]="loading"
        />
        <button
          type="button"
          class="password-toggle"
          (click)="togglePasswordVisibility('new')"
          [attr.aria-label]="showNewPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
        >
          <fa-icon [icon]="showNewPassword ? faEyeSlash : faEye"></fa-icon>
        </button>
      </div>

      <!-- Indicador de fortaleza -->
      <div class="password-strength" *ngIf="changePasswordForm.get('newPassword')?.value">
        <div class="strength-bar">
          <div
            class="strength-fill"
            [style.width.%]="passwordStrength.score"
            [style.background-color]="passwordStrength.color"
          ></div>
        </div>
        <span class="strength-label" [style.color]="passwordStrength.color">
          {{ passwordStrength.label }}
        </span>
      </div>

      <div class="error-message" *ngIf="hasError('newPassword')">
        {{ getErrorMessage('newPassword') }}
      </div>

      <!-- Requisitos de la contraseña -->
      <div class="password-requirements" *ngIf="changePasswordForm.get('newPassword')?.touched">
        <p class="requirements-title">Requisitos:</p>
        <ul class="requirements-list">
          <li [class.valid]="hasMinLength()">
            <fa-icon [icon]="faCheck"></fa-icon>
            Al menos 8 caracteres
          </li>
          <li [class.valid]="hasUpperCase()">
            <fa-icon [icon]="faCheck"></fa-icon>
            Una letra mayúscula
          </li>
          <li [class.valid]="hasLowerCase()">
            <fa-icon [icon]="faCheck"></fa-icon>
            Una letra minúscula
          </li>
          <li [class.valid]="hasNumber()">
            <fa-icon [icon]="faCheck"></fa-icon>
            Un número
          </li>
          <li [class.valid]="hasSpecialChar()">
            <fa-icon [icon]="faCheck"></fa-icon>
            Un carácter especial (&#64;$!%*?&#38;)
          </li>
        </ul>
      </div>
    </div>

    <!-- Confirmar Nueva Contraseña -->
    <div class="form-group">
      <label for="confirmPassword" class="form-label">
        <fa-icon [icon]="faCheck" class="label-icon"></fa-icon>
        Confirmar Nueva Contraseña
      </label>
      <div class="input-wrapper">
        <input
          [type]="showConfirmPassword ? 'text' : 'password'"
          id="confirmPassword"
          class="form-control"
          [class.is-invalid]="hasError('confirmPassword')"
          formControlName="confirmPassword"
          placeholder="Confirme su nueva contraseña"
          autocomplete="new-password"
          [disabled]="loading"
        />
        <button
          type="button"
          class="password-toggle"
          (click)="togglePasswordVisibility('confirm')"
          [attr.aria-label]="showConfirmPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
        >
          <fa-icon [icon]="showConfirmPassword ? faEyeSlash : faEye"></fa-icon>
        </button>
      </div>
      <div class="error-message" *ngIf="hasError('confirmPassword')">
        {{ getErrorMessage('confirmPassword') }}
      </div>
    </div>
  </form>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" (click)="close()" [disabled]="loading">
    Cancelar
  </button>
  <button
    type="submit"
    class="btn btn-primary"
    (click)="onSubmit()"
    [disabled]="loading"
    [class.loading]="loading"
  >
    <span *ngIf="!loading">
      <fa-icon [icon]="faCheck"></fa-icon>
      Cambiar Contraseña
    </span>
    <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
    <span *ngIf="loading">Cambiando...</span>
  </button>
</div>
